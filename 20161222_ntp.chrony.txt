2016-12-22
# edit by liu2lin600

♦ ntp

	在计算机世界中，NTP（Network Time Protocol,网络时间协议）被广泛用于对时间的统一性和准确性要求非常高的场景，是用来使网络中的各个计算机时间同步的一种协议。它可以把计算机时钟同步到世界协调时UTC(Universal Time Coordinated,世界协调时）。UTC是由原子钟报时的国际标准时间，而NTP获得UTC的时间来源可以是原子钟、天文台、卫星，也可从internet上面获取。在NTP协议中，定义了时间按照服务器等级传播，依据离外部UTC源的远近，将所有服务器归入不同的stratum（层）中，直接从时间源如GPRS(Global Positioning System，全球定位系统）获得时间的服务器称之为stratum-1，而后依次序递归传播给下层服务器stratum-2、stratum-3…，层的总数限制在15以内

	◇ NTP通信协议原理

		1. 首先主机启动NTP服务
		2. client会向NTP服务器发送调整时间的消息
		3. 然后NTP服务器会送出当前的标准时间给client
		4. client会根据这个信息来调整自己的时间，

		NTP这个deamon采用了UDP 123端口。当我们要利用Tim server来进行实践的同步更新时，就需要使用NTP软件提供的ntpdate来连接端口123

	◇ 相关文件
		• /etc/ntp.conf: ntp主配置文件
		• /usr/share/zoneinfo/: 时区的时间设置文件
		• /etc/localtime: 本地端时间配置文件，
		• /etc/sysconfig/clock: 时区设置文件，每次开机后linux会自动读取这个文件来设置系统所默认的显示时间
			
			# The ZONE parameter is only evaluated by system-config-date.
			# The timezone of the system is defined by the contents of /etc/localtime.
			ZONE="Asia/Shanghai"
			UTC=true
			ARC=false
		
	◇ 相关命令
		• /bin/date: 这个是时间的修改命令，除了输出时间，还可以修改时间
		• /sbin/hwclock: 因为linux系统上面BIOS时间与linux系统时间是分开的，所以使用date这个指令调整了时间之后，还需要使用hwclock才能将修改过的时间写入BIOS中
		• /usr/sbin/ntpd: 这是NTP的daemon文件，需要启动它才能提供NTP服务，这个命令会读取/etc/ntp.conf里面的设置
		• /usr/sbin/ntpdate: 这是client用来连接NTP Server的主要执行文件，如果您不想启用NTP，只想启用NTP Client功能的话，可以只应用此命令
		• /usr/sbin/ntptrace: 可以用来追踪某台时间服务器的时间对应关系
		• /user/sbin/ntpq: 查看ntp服务器与上层ntp服务器的状态
		• /usr/bin/ntpstat: 查看是否与服务器同步

	◇ 安装配置
		ntpd即可提供时间服务端也可以作为客户端去请求服务器同步时间，同步时间

		1. 设置时区:cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
		2. 安装ntpd服务:yum -y install ntp
		3. 配置/etc/ntp.conf

			# 限制条件
			restrict default kod nomodify notrap nopeer noquery
			restrict -6 default kod nomodify notrap nopeer noquery  #针对ipv6设置
			 
			# 允许本地所有操作
			restrict 127.0.0.1
			restrict -6 ::1
			 
			# 允许的局域网络段或单独ip
			restrict 10.0.0.0 mask 255.0.0.0 nomodify motrap
			restrict 192.168.0.0 mask 255.255.255.0 nomodify motrap
			restrict 192.168.1.123 mask 255.255.255.255 nomodify motrap
			 
			# 使用上层的internet ntp服务器
			server cn.pool.ntp.org prefer
			server 0.asia.pool.ntp.org
			server 3.asia.pool.ntp.org
			server 0.centos.pool.ntp.org iburst
			 
			# 如果无法与上层ntp server通信以本地时间为标准时间
			server   127.127.1.0    # local clock
			fudge    127.127.1.0 stratum 10
			 
			# 计算本ntp server 与上层ntpserver的频率误差
			driftfile /var/lib/ntp/drift
			 
			# Key file containing the keys and key identifiers used when operating
			# with symmetric key cryptography.
			keys /etc/ntp/keys
 
			#日志文件
			logfile /var/log/ntp.log

		4. 修改/etc/sysconfig/ntpd:

			# Drop root to id 'ntp:ntp' by default.
			OPTIONS="-u ntp:ntp -p /var/run/ntpd.pid"
			# Set to 'yes' to sync hw clock after successful ntpdate
			SYNC_HWCLOCK=yes #make no into yes; BIOS的时间也会跟着修改
			# Additional options for ntpdate
			NTPDATE_OPTIONS=""

		► 说明
			restrict [address] mask [netmask_ip] [parameter]

			其中parameter的参数主要有：
				ignore     ：    拒绝所有类型的ntp连接
				nomodify   ：    客户端不能使用ntpc与ntpq两支程式来修改服务器的时间参数
				noquery    ：    客户端不能使用ntpq、ntpc等指令来查询服务器时间，等于不提供ntp的网络校时
				notrap     ：    不提供trap这个远程时间登录的功能
				notrust    ：    拒绝没有认证的客户端
				nopeer     ：    不与其他同一层的ntp服务器进行时间同步

	◇ 启动服务及命令用法
		• service ntpd start|status|stop 	# 监听123/udp

		• ntpstat 	# 此命令出现上述synchronised结果比较慢

			synchronised to NTP server (10.10.255.2) at stratum 4 	# 已同步
   				time correct to within 101 ms 	# 校正101ms
   				polling server every 16 s 		# 每16s校正一次

		• ntpq -p 	# 

				 remote           refid      st t when poll reach   delay   offset  jitter
			==============================================================================
			+10.10.255.1     202.118.1.130    3 u   14   16  377    0.479   15.205   1.586
			*10.10.255.2     120.25.108.11    3 u    4   16  377    0.723   14.866   1.279
			+202.118.1.130   202.118.1.48     2 u    2   16  377   13.204   25.797   5.533
			
			· remote ： 本机和上层ntp的ip或主机名
				'*'：它告诉我们远端的服务器已经被确认为我们的主NTP Server
				'+'：辅助服务器，当*号服务器不可用时它就可以接管
			    '-'：不合格的NTP Server
				'x'：远程服务器不可用
			· refid  ： 参考上一层ntp主机地址
			· st     ： stratum阶层
			· when   ： 多少秒前曾经同步过时间
			· poll   ： 下次更新在多少秒后
			· reach  ： 已经向上层ntp服务器要求更新的次数
			· delay  ： 网络延迟
			· offset ： 时间补偿
			· jitter ： 系统时间与bios时间差

		• date命令
			[work@relay ~]$ date
			2016年 12月 22日 星期四 21:40:30 CST 		# 标准北京时间
			[work@relay ~]$ date -u 
			2016年 12月 22日 星期四 13:40:32 UTC 		# 国际协调时间，基本等同格林威治时间(GMT)

		• tzselect命令：手动设置时区

## chrony

♦ 



## ntpdate
	
	手动对时命令，由ntpdate包提供，推荐使用ntpd自动对时

	ntpd是步进式的逐渐调整时间，而ntpdate是断点更新，比如现在服务器时间是9.18分，而标准时间是9.28分，ntpd会在一段时间内逐渐的把时间校准到与标准时间相同，而ntpdate会立刻把时间调整到9.28分，如果你往数据库内写入内容或在其他对时间有严格要求的生产环境下，产生的后果会是很严重的。（注：当本地时间与标准时间相差30分钟以上是ntpd会停止工作）


	◇ ntpdate SERVER_IP|HOST



